namespace = carnx_slave

scripted_trigger carnx_slave_0009_valid_liege_trigger = {
	is_available_adult = yes
	carnx_is_slave_owner_trigger = yes
}

scripted_trigger carnx_slave_0009_valid_slave_trigger = {
	is_available_ai_adult = yes
	reverse_opinion = {
		target = root
		value > medium_negative_opinion
	}
	NOR = {
		root = { has_execute_reason = prev }
		has_relation_rival = root
	}
}

# The Price of Freedom
carnx_slave.0009 = {
	type = character_event
	title = carnx_slave.0009.t
	desc = carnx_slave.0009.desc

	theme = realm
	left_portrait = {
		character = scope:slave
		animation = beg
	}
	override_background = {
		reference = throne_room
	}

	trigger = {
		NOT = { has_game_rule = carn_slavery_content_disabled }
		NOT = { has_character_flag = had_event_carnx_slave_0009 }
		carnx_slave_0009_valid_liege_trigger = yes
		any_relation = {
			type = slave
			carnx_slave_0009_valid_slave_trigger = yes
			gold >= carnx_slave_ransom_cost_value
		}
	}

	weight_multiplier = {
		base = 1

		# Weight up for compassionate rulers, weight down for sadistic and callous ones
		modifier = {
			has_trait = compassionate
			add = 0.5
		}
		modifier = {
			has_trait = sadistic
			add = -0.5
		}
		modifier = {
			has_trait = callous
			add = -0.25
		}
	}

	immediate = {
		hidden_effect = {
			carnx_debug_log_effect = { MSG = carnx_debug_msg_slave_0009_fired }
		}
		add_character_flag = {
			flag = had_event_carnx_slave_0009
			years = 3
		}

		# Find a valid slave who can afford their freedom
		random_relation = {
			type = slave
			limit = {
				carnx_slave_0009_valid_slave_trigger = yes
				gold >= carnx_slave_ransom_cost_value
			}

			weight = {
				base = 50

				# Owner's opinion of slave
				opinion_modifier = {
					who = root
					opinion_target = this
					multiplier = 0.5
				}

				# Greed
				ai_value_modifier = {
					ai_greed = -0.5
				}
			}

			save_scope_as = slave
		}

		# Save ransom cost
		scope:slave = {
			set_variable = {
				name = carnx_slave_0009_ransom_cost
				value = carnx_slave_ransom_cost_value
				days = 2
			}
		}
	}

	# Accept the gold and grant freedom
	option = {
		name = carnx_slave.0009.a

		# Free the slave
		send_interface_message = {
			type = event_generic_neutral
			title = carn_msg_slave_freed
			right_icon = scope:slave

			scope:slave = {
				carn_free_slave_effect = yes
				pay_short_term_gold = {
					gold = var:carnx_slave_0009_ransom_cost
					target = root
				}
				add_opinion = {
					modifier = grateful_opinion
					target = root
					opinion = 20
				}
			}
		}

		stress_impact = {
			compassionate = minor_stress_impact_loss
			sadistic = minor_stress_impact_gain
			callous = miniscule_stress_impact_gain
		}

		hidden_effect = {
			carnx_debug_log_effect = { MSG = carnx_debug_msg_slave_0009_option_a_chosen }
		}

		ai_chance = {
			base = 50

			# Opinion of slave
			opinion_modifier = {
				opinion_target = scope:slave
				multiplier = 0.25
			}

			ai_value_modifier = {
				ai_compassion = 0.25
				ai_greed = -0.10
			}

			# Slavery crime or shunned by faith
			modifier = {
				carnx_is_slavery_crime_trigger = { CHARACTER = scope:slave }
				add = carnx_ai_positive_crime_impact_reduced_value # 0-50 depending on zeal
			}
			modifier = {
				carnx_is_slavery_shunned_trigger = { CHARACTER = scope:slave }
				add = carnx_ai_positive_shunned_impact_reduced_value # 0-12 depending on zeal
			}

			# Liberators more likely to free
			modifier = {
				has_character_modifier = carnx_slavery_attitude_liberator_modifier
				add = 25
			}

			# Weight up or down for stress
			modifier = {
				has_trait = compassionate
				add = 10
			}
			modifier = {
				has_trait = sadistic
				add = -10
			}
			modifier = {
				has_trait = callous
				add = -5
			}
		}
	}

	# Refuse the offer
	option = {
		name = carnx_slave.0009.b

		scope:slave = {
			add_opinion = {
				modifier = disappointed_opinion
				target = root
				opinion = -20
			}
		}

		# Remove piety
		if = {
			limit = { carnx_is_slavery_crime_trigger = { CHARACTER = scope:slave } }
			add_piety = carnx_slavery_major_piety_loss
			carnx_slavery_doctrines_stress_impact_effect = yes
		}
		else_if = {
			limit = { carnx_is_slavery_shunned_trigger = { CHARACTER = scope:slave } }
			add_piety = carnx_slavery_piety_loss
			carnx_slavery_doctrines_minor_stress_impact_effect = yes
		}

		stress_impact = {
			compassionate = medium_stress_impact_gain
			sadistic = medium_stress_impact_loss
			callous = minor_stress_impact_loss
		}

		hidden_effect = {
			carnx_debug_log_effect = { MSG = carnx_debug_msg_slave_0009_option_b_chosen }
		}

		ai_chance = {
			base = 50

			opinion_modifier = {
				opinion_target = scope:slave
				multiplier = -0.25
			}

			ai_value_modifier = {
				ai_compassion = -0.25
				ai_greed = 0.10
			}

			# Slavers, traders, and employers less likely to free
			modifier = {
				OR = {
					has_character_modifier = carnx_slavery_attitude_slaver_modifier
					has_character_modifier = carnx_slavery_attitude_trader_modifier
					has_character_modifier = carnx_slavery_attitude_employer_modifier
				}
				add = 25
			}

			# Weight up or down for stress
			modifier = {
				has_trait = compassionate
				add = -20
			}
			modifier = {
				has_trait = sadistic
				add = 20
			}
			modifier = {
				has_trait = callous
				add = 10
			}
		}
	}
}
